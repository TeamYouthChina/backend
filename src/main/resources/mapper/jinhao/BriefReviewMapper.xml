<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.youthchina.dao.jinhao.BriefReviewMapper">
    <insert id="add" parameterType="com.youthchina.domain.jinhao.communityQA.BriefReview">
        insert into COM_BRIEF_REVIEW (review_content, review_time, is_delete, is_delete_time)
        values (#{review_content}, #{review_time}, #{is_delete}, #{is_delete_time})
    </insert>

    <insert id="createReviewMap">
        insert into COM_BRIEF_REVIEW_MAP(review_id, user_id, rela_type, rela_id) VALUES
            (#{review_id}, #{user_id}, #{rela_type}, #{rela_id})
    </insert>

    <update id="delete" parameterType="java.lang.Integer">
        update COM_BRIEF_REVIEW set IS_DELETE=1, IS_DELETE_TIME=now() where REVIEW_ID=#{id}
    </update>

    <update id="deleteAllReviewEvaluationByReviewId" parameterType="java.lang.Integer">
        update COM_REVIEW_EVALUATE set EVALUATE_TYPE=3, EVALUATE_TIME=now() where EVALUATE_ID in (
            select EVALUATE_ID from COM_REVIEW_EVALUATE_MAP where REVIEW_ID=#{id}
        )
    </update>

    <update id="deleteAllCommentsByReviewId" parameterType="java.lang.Integer">
        update COM_REVIEW_COMMENT set IS_DELETE=1, IS_DELETE_TIME=now() where COMMENT_ID in (
          select COMMENT_ID from COM_REVIEW_COMMENT_MAP where REVIEW_ID=#{id}
            )
    </update>
    <update id="deleteAllCommentEvaluationByReviewId" parameterType="java.lang.Integer">
        update COM_REVIEW_COMMENT_EVALUATE set EVALUATE_TYPE=3, EVALUATE_TIME=now() where EVALUATE_ID in (
          select EVALUATE_ID from COM_REVIEW_COMMENT_EVALUATE_MAP where COMMENT_ID in (
            select COMMENT_ID from COM_REVIEW_COMMENT_MAP where REVIEW_ID=#{id}
              )
            )
    </update>
    <update id="deleteAllDiscussesByReviewId" parameterType="java.lang.Integer">
        update COM_REVIEW_COMMENT_DISCUSS set IS_DELETE=1, IS_DELETE_TIME=now() where DISCUSS_ID in (
          select DISCUSS_ID from COM_REVIEW_COMMENT_DISCUSS_MAP where COMMENT_ID in (
            select COMMENT_ID from COM_REVIEW_COMMENT_MAP where REVIEW_ID=#{id}
              )
            )
    </update>
    <update id="deleteAllDiscussEvaluateByReviewId" parameterType="java.lang.Integer">
        update COM_REVIEW_DISCUSS_EVALUATE set EVALUATE_TYPE=3, EVALUATE_TIME=now() where EVALUATE_ID in (
          select EVALUATE_ID from COM_REVIEW_DISCUSS_EVALUATE_MAP where DISCUSS_ID in (
            select DISCUSS_ID from COM_REVIEW_COMMENT_DISCUSS_MAP where COMMENT_ID in (
              select COMMENT_ID from COM_REVIEW_COMMENT_MAP where REVIEW_ID=#{id}
                )
              )
            )
    </update>
    <update id="update" parameterType="com.youthchina.domain.jinhao.communityQA.BriefReview">
        update COM_BRIEF_REVIEW set REVIEW_CONTENT=#{review_content}, REVIEW_TIME=now()
        where REVIEW_ID=#{review_id}
    </update>

    <select id="get" parameterType="java.lang.Integer" resultType="com.youthchina.domain.jinhao.communityQA.BriefReview">
        select * from COM_BRIEF_REVIEW where REVIEW_ID=#{review_id} and IS_DELETE=0
    </select>

    <select id="getList" resultType="com.youthchina.domain.jinhao.communityQA.BriefReview"
    parameterType="java.util.List">
        select * from COM_BRIEF_REVIEW where IS_DELETE=0 and REVIEW_ID in
        <foreach item='id' index='index' collection="list" separator="," open="(" close=")">
            #{id}
        </foreach>

    </select>

    <insert id="addReviewEvaluation" parameterType="com.youthchina.domain.jinhao.communityQA.Evaluate">
        insert into COM_REVIEW_EVALUATE(USER_ID, EVALUATE_TYPE, EVALUATE_TIME) VALUES
            (#{user_id}, #{evaluate_type},#{evaluate_time})
    </insert>
    <insert id="createEvaluationReviewMap">
        insert into COM_REVIEW_EVALUATE_MAP(evaluate_id, review_id) VALUES (#{evaluate_id}, #{review_id})
    </insert>
    <select id="checkEvaluateStatus" resultType="com.youthchina.domain.jinhao.communityQA.Evaluate">
        select e.* from COM_REVIEW_EVALUATE_MAP m,COM_REVIEW_EVALUATE e
        where e.USER_ID=#{user_id} and m.EVALUATE_ID = e.EVALUATE_ID and m.REVIEW_ID=#{review_id}
    </select>
    <update id="updateEvaluation" parameterType="com.youthchina.domain.jinhao.communityQA.Evaluate">
        update COM_REVIEW_EVALUATE set EVALUATE_TYPE=#{evaluate_id}, EVALUATE_TIME=now()
        where EVALUATE_ID=#{evaluate_id}
    </update>
    <select id="getEvaluate" parameterType="java.lang.Integer"
            resultType="com.youthchina.domain.jinhao.communityQA.Evaluate">
        select * from COM_REVIEW_EVALUATE where EVALUATE_ID=#{evaluate_id}
    </select>

    <insert id="addComment" parameterType="com.youthchina.domain.jinhao.communityQA.Comment">
        insert into COM_REVIEW_COMMENT(comment_content, user_id, comment_pub_time)
        values (#{comment_content}, #{user_id}, #{comment_pub_time})
    </insert>
    <insert id="createCommentReviewMap">
        insert into COM_REVIEW_COMMENT_MAP(comment_id, comment_level, review_id) VALUES
            (#{comment_id},#{comment_level},#{review_id})
    </insert>
    <update id="deleteComment" parameterType="java.lang.Integer">
        update COM_REVIEW_COMMENT set IS_DELETE=1,IS_DELETE_TIME=now() where COMMENT_ID=#{id}
    </update>
    <update id="deleteAllCommentEvaluationByCommentId" parameterType="java.lang.Integer">
        update COM_COMMENT_EVALUATE set EVALUATE_TYPE=3,EVALUATE_TIME=now()
        where EVALUATE_ID in (select EVALUATE_ID from COM_COMMENT_EVALUATE_MAP where COMMENT_ID = #{id})
    </update>
    <update id="deleteAllDiscussByCommentId" parameterType="java.lang.Integer">
        update COM_COMMENT_DISCUSS set IS_DELETE=1, IS_DELETE_TIME=now() where DISCUSS_ID in(
          select DISCUSS_ID from COM_REVIEW_COMMENT_DISCUSS_MAP where COMMENT_ID=#{id}
            )
    </update>
    <update id="deleteAllDiscussEvaluationByCommentId" parameterType="java.lang.Integer">
        update COM_REVIEW_DISCUSS_EVALUATE set EVALUATE_TYPE=3,EVALUATE_TIME=now() where EVALUATE_ID in (
          select EVALUATE_ID from COM_REVIEW_DISCUSS_EVALUATE_MAP where DISCUSS_ID in (
            select DISCUSS_ID from COM_REVIEW_COMMENT_DISCUSS_MAP where COMMENT_ID = #{id}
              )
            )
    </update>
    <update id="updateComment" parameterType="com.youthchina.domain.jinhao.communityQA.Comment">
        update COM_REVIEW_COMMENT set COMMENT_CONTENT=#{comment_content}, COMMENT_PUB_TIME=now(),USER_ANONY=#{user_anony}
        where COMMENT_ID = #{comment_id}
    </update>
    <select id="getComment" parameterType="java.lang.Integer" resultType="com.youthchina.domain.jinhao.communityQA.Comment">
        select * from COM_REVIEW_COMMENT where COMMENT_ID=#{id}
    </select>
    <select id="getAllCommentsOfReview" parameterType="java.lang.Integer" resultType="com.youthchina.domain.jinhao.communityQA.Comment">
        select c.* from COM_REVIEW_COMMENT c, COM_REVIEW_COMMENT_MAP m where c.COMMENT_ID = m.COMMENT_ID and m.REVIEW_ID=#{id}
    </select>
    <insert id="addCommentEvaluation" parameterType="com.youthchina.domain.jinhao.communityQA.Evaluate">
        insert into COM_REVIEW_COMMENT_EVALUATE(user_id, evaluate_type, evaluate_time) VALUES
            (#{user_id}, #{evaluate_type},#{evaluate_time})
    </insert>
    <insert id="createEvaluationCommentMap">
        insert into COM_REVIEW_COMMENT_EVALUATE_MAP(evaluate_id, comment_id) VALUES (#{evaluate_id},#{comment_id})
    </insert>
</mapper>